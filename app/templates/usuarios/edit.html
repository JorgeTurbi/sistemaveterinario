{% extends "base.html" %}

{% block title %}Editar Usuario - {{ app_name }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-0"><i class="bi bi-pencil me-2"></i>Editar Usuario</h2>
                <small class="text-muted">Modificar cuenta: {{ usuario.username }}</small>
            </div>
            <a href="{{ url_for('usuarios.index') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i> Volver
            </a>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <form method="POST" action="{{ url_for('usuarios.edit', id=usuario.id_usuario) }}">
                    <!-- Info del usuario -->
                    <div class="bg-light p-3 rounded mb-4">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <div class="bg-{{ usuario.rol_color }} bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                    <i class="bi bi-person-fill text-{{ usuario.rol_color }} fs-3"></i>
                                </div>
                            </div>
                            <div class="col">
                                <h5 class="mb-0">{{ usuario.username }}</h5>
                                <small class="text-muted">
                                    Creado: {{ usuario.fecha_creacion.strftime('%d/%m/%Y') if usuario.fecha_creacion else 'N/A' }}
                                    {% if usuario.ultimo_acceso %}
                                    | Ultimo acceso: {{ usuario.ultimo_acceso.strftime('%d/%m/%Y %H:%M') }}
                                    {% endif %}
                                </small>
                            </div>
                            <div class="col-auto">
                                {% if usuario.id_usuario == current_user.id_usuario %}
                                <span class="badge bg-info">Tu cuenta</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Datos personales -->
                    <h6 class="text-muted mb-3"><i class="bi bi-person me-2"></i>Datos Personales</h6>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Nombre Completo <span class="text-danger">*</span></label>
                            <input type="text" name="nombre_completo" class="form-control"
                                   value="{{ usuario.nombre_completo }}" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                                <input type="email" name="email" class="form-control"
                                       value="{{ usuario.email }}" required>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Rol <span class="text-danger">*</span></label>
                            <select name="rol" class="form-select" id="rol_select">
                                {% for r in roles %}
                                <option value="{{ r }}" {% if usuario.rol == r %}selected{% endif %}>{{ r }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Estado</label>
                            <div class="form-check form-switch mt-2">
                                <input type="checkbox" name="activo" class="form-check-input"
                                       id="activo" {% if usuario.activo %}checked{% endif %}
                                       {% if usuario.id_usuario == current_user.id_usuario %}disabled{% endif %}>
                                <label class="form-check-label" for="activo">Usuario Activo</label>
                            </div>
                            {% if usuario.id_usuario == current_user.id_usuario %}
                            <small class="text-muted">No puedes desactivar tu propia cuenta</small>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Vincular veterinario -->
                    <div id="vincular_veterinario_section" style="display: none;">
                        <hr class="my-4">
                        <h6 class="text-muted mb-3"><i class="bi bi-link-45deg me-2"></i>Vincular con Veterinario</h6>

                        <div class="mb-3">
                            <label class="form-label">Ficha de Veterinario</label>
                            <select name="vincular_veterinario" class="form-select">
                                <option value="">-- Sin vincular --</option>
                                {% for vet in veterinarios_disponibles %}
                                <option value="{{ vet.id_veterinario }}"
                                        {% if usuario.veterinario and usuario.veterinario.id_veterinario == vet.id_veterinario %}selected{% endif %}>
                                    {{ vet.nombre }} - {{ vet.especialidad or 'General' }}
                                </option>
                                {% endfor %}
                            </select>
                            {% if usuario.veterinario %}
                            <small class="text-success">
                                <i class="bi bi-check-circle me-1"></i>Actualmente vinculado con: {{ usuario.veterinario.nombre }}
                            </small>
                            {% endif %}
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- Cambiar contrasena -->
                    <h6 class="text-muted mb-3"><i class="bi bi-key me-2"></i>Cambiar Contrasena (Opcional)</h6>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Nueva Contrasena</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-lock"></i></span>
                                <input type="password" name="nueva_password" class="form-control"
                                       placeholder="Dejar vacio para mantener" minlength="6">
                            </div>
                            <small class="text-muted">Minimo 6 caracteres. Dejar vacio si no desea cambiarla.</small>
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <form action="{{ url_for('usuarios.reset_password', id=usuario.id_usuario) }}"
                                  method="POST" class="w-100"
                                  onsubmit="return confirm('Se reseteara la contrasena a: {{ usuario.username }}123')">
                                <button type="submit" class="btn btn-outline-warning w-100">
                                    <i class="bi bi-arrow-clockwise me-1"></i> Resetear Contrasena
                                </button>
                            </form>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="d-flex justify-content-between">
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-lg me-1"></i> Guardar Cambios
                            </button>
                            <a href="{{ url_for('usuarios.index') }}" class="btn btn-outline-secondary">
                                Cancelar
                            </a>
                        </div>

                        {% if usuario.id_usuario != current_user.id_usuario %}
                        <form action="{{ url_for('usuarios.delete', id=usuario.id_usuario) }}"
                              method="POST"
                              onsubmit="return confirm('Eliminar este usuario? Esta accion lo desactivara.')">
                            <button type="submit" class="btn btn-outline-danger">
                                <i class="bi bi-trash me-1"></i> Eliminar
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const rolSelect = document.getElementById('rol_select');
    const vincularSection = document.getElementById('vincular_veterinario_section');

    function toggleVincular() {
        if (rolSelect.value === 'Veterinario') {
            vincularSection.style.display = 'block';
        } else {
            vincularSection.style.display = 'none';
        }
    }

    rolSelect.addEventListener('change', toggleVincular);
    toggleVincular();
});
</script>
{% endblock %}
